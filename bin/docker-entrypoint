#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# Wait for PostgreSQL to be ready (only if DB_HOST is set)
if [ -n "$DB_HOST" ]; then
    until pg_isready -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME"; do
        echo "Waiting for PostgreSQL to be ready at $DB_HOST:$DB_PORT..."
        sleep 1
    done
    echo "PostgreSQL is ready!"
elif [ -n "$DATABASE_URL" ]; then
    # Extract host from DATABASE_URL for pg_isready check
    DB_HOST=$(echo $DATABASE_URL | sed -n 's/.*@\([^:/]*\).*/\1/p')
    until pg_isready -h "$DB_HOST" -U postgres 2>/dev/null || rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" 2>/dev/null; do
        echo "Waiting for PostgreSQL to be ready..."
        sleep 2
    done
    echo "PostgreSQL is ready!"
fi

# Run database migrations for production
if [ "$RAILS_ENV" = "production" ]; then
    echo "Running database migrations..."
    bundle exec rails db:migrate
    echo "Database migrations complete!"
fi

# Execute the original command
exec "$@"